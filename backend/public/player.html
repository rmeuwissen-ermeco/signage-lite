<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Signage Lite Player</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
    }
    #pairing, #playback, #error {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    #pairing {
      background: radial-gradient(circle at top, #333 0, #000 60%);
    }
    #pairing h1 {
      font-size: 32px;
      margin-bottom: 8px;
    }
    #pairing-code {
      font-size: 72px;
      letter-spacing: 8px;
      font-weight: 600;
      margin: 16px 0;
    }
    #pairing-timer {
      font-size: 18px;
      margin-top: 8px;
      color: #ccc;
    }
    #pairing small {
      margin-top: 16px;
      color: #aaa;
    }

    #playback {
      background: #000;
      align-items: stretch;
      justify-content: stretch;
    }
    #media-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    #media-container img,
    #media-container video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* wordt overschreven door JS via inline style */
    background: #000;
    display: block;
    }

    #debug-overlay {
      position: absolute;
      left: 8px;
      bottom: 8px;
      background: rgba(0,0,0,0.5);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      color: #ccc;
      line-height: 1.3;
      text-align: left;
    }

    #error {
      background: #300;
      color: #fee;
      padding: 20px;
    }
  </style>
</head>
<body>

<div id="pairing">
  <h1>Signage Lite Player</h1>
  <p>Voer deze koppelingcode in bij de beheeromgeving:</p>
  <div id="pairing-code">------</div>
  <div id="pairing-timer">Nog --:-- min geldig</div>
  <small>De code wordt automatisch vernieuwd na afloop.<br>
  Dit scherm controleert elke paar seconden of de player gekoppeld is.</small>
</div>

<div id="playback" style="display:none;">
  <div id="media-container"></div>
  <div id="debug-overlay">
    <div id="debug-playlist">Playlist: laden…</div>
    <div id="debug-canvas">Canvas: onbekend — screen: onbekend</div>
    <div id="debug-slide">Slide: —</div>
  </div>
</div>

<div id="error" style="display:none;">
  <h2>Verbinding verloren</h2>
  <p id="error-message"></p>
  <p>Probeer de pagina te vernieuwen of controleer de server.</p>
</div>

<script>
const API_BASE = "";
const POLL_STATUS_INTERVAL_MS = 3000;
const POLL_PLAYLIST_INTERVAL_MS = 15000;

let registerInterval = null;
let statusInterval = null;
let playlistInterval = null;
let pairingTimerInterval = null;
let slideTimeout = null;

let currentDeviceId = null;
let currentDeviceToken = null;
let currentPlayerId = null;
let currentPlaylistVersion = null;
let currentItems = [];
let currentFitMode = "CONTAIN"; // standaard

let pairingExpiresAt = null;

const pairingView = document.getElementById("pairing");
const playbackView = document.getElementById("playback");
const errorView = document.getElementElementById?.("error") || document.getElementById("error");
const pairingCodeEl = document.getElementById("pairing-code");
const pairingTimerEl = document.getElementById("pairing-timer");
const errorMessageEl = document.getElementById("error-message");
const mediaContainer = document.getElementById("media-container");

const debugPlaylistEl = document.getElementById("debug-playlist");
const debugCanvasEl = document.getElementById("debug-canvas");
const debugSlideEl = document.getElementById("debug-slide");

function showPairing() {
  pairingView.style.display = "flex";
  playbackView.style.display = "none";
  errorView.style.display = "none";
}

function showPlayback() {
  pairingView.style.display = "none";
  playbackView.style.display = "flex";
  errorView.style.display = "none";
}

function showError(msg) {
  pairingView.style.display = "none";
  playbackView.style.display = "none";
  errorView.style.display = "flex";
  errorMessageEl.textContent = msg;
}

function saveAuth() {
  const data = {
    deviceId: currentDeviceId,
    deviceToken: currentDeviceToken,
    playerId: currentPlayerId,
  };
  localStorage.setItem("signageLiteDevice", JSON.stringify(data));
}

function loadAuth() {
  try {
    const raw = localStorage.getItem("signageLiteDevice");
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (_) {
    return null;
  }
}

function clearIntervals() {
  if (registerInterval) {
    clearInterval(registerInterval);
    registerInterval = null;
  }
  if (statusInterval) {
    clearInterval(statusInterval);
    statusInterval = null;
  }
  if (playlistInterval) {
    clearInterval(playlistInterval);
    playlistInterval = null;
  }
  if (pairingTimerInterval) {
    clearInterval(pairingTimerInterval);
    pairingTimerInterval = null;
  }
}

function clearSlideshow() {
  if (slideTimeout) {
    clearTimeout(slideTimeout);
    slideTimeout = null;
  }
  mediaContainer.innerHTML = "";
  debugSlideEl.textContent = "Slide: —";
}

function startPairingFlow() {
  clearIntervals();
  clearSlideshow();
  showPairing();

  pairingCodeEl.textContent = "------";
  pairingTimerEl.textContent = "Nog --:-- min geldig";

  registerDevice().catch(err => {
    console.error("Fout bij registerDevice:", err);
    showError("Kan geen koppelingcode ophalen van de server.");
  });
}

function updatePairingTimer() {
  if (!pairingExpiresAt) return;
  const now = Date.now();
  const diff = pairingExpiresAt - now;

  if (diff <= 0) {
    pairingTimerEl.textContent = "Code verlopen, nieuwe code aanvragen…";
    if (pairingTimerInterval) {
      clearInterval(pairingTimerInterval);
      pairingTimerInterval = null;
    }
    startPairingFlow();
    return;
  }

  const totalSeconds = Math.floor(diff / 1000);
  const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
  const seconds = String(totalSeconds % 60).padStart(2, "0");
  pairingTimerEl.textContent = `Nog ${minutes}:${seconds} min geldig`;
}

async function registerDevice() {
  const platform = "browser";
  const deviceName = navigator.userAgent || "Browser player";

  const res = await fetch(`${API_BASE}/api/devices/register`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ platform, deviceName })
  });

  if (!res.ok) {
    throw new Error("Register mislukt: " + res.status);
  }

  const data = await res.json();
  currentDeviceId = data.deviceId;
  pairingCodeEl.textContent = data.pairingCode;

  pairingExpiresAt = new Date(data.expiresAt).getTime();

  if (pairingTimerInterval) {
    clearInterval(pairingTimerInterval);
  }
  pairingTimerInterval = setInterval(updatePairingTimer, 1000);
  updatePairingTimer();

  if (statusInterval) {
    clearInterval(statusInterval);
  }
  statusInterval = setInterval(checkDeviceStatus, POLL_STATUS_INTERVAL_MS);
  await checkDeviceStatus();
}

async function checkDeviceStatus() {
  if (!currentDeviceId) return;

  try {
    const res = await fetch(`${API_BASE}/api/devices/${currentDeviceId}/status`);
    if (!res.ok) {
      console.warn("Status fout:", res.status);
      return;
    }
    const data = await res.json();

    if (data.status === "PAIRED") {
      currentPlayerId = data.playerId;
      currentDeviceToken = data.deviceToken;
      saveAuth();
      startPlaybackFlow();
    }
  } catch (err) {
    console.error("Fout bij status-check:", err);
  }
}

function authHeaders() {
  return {
    "Authorization": `Bearer ${currentDeviceToken}`,
    "Content-Type": "application/json",
  };
}

async function sendScreenInfo() {
  if (!currentDeviceToken) return;

  const screenWidth = window.innerWidth;
  const screenHeight = window.innerHeight;

  try {
    await fetch(`${API_BASE}/api/device/screen`, {
      method: "POST",
      headers: authHeaders(),
      body: JSON.stringify({
        screenWidth,
        screenHeight,
      }),
    });
  } catch (err) {
    console.error("Fout bij sturen screen info:", err);
  }
}

async function fetchPlaylist() {
  try {
    const res = await fetch(`${API_BASE}/api/device/playlist`, {
      headers: {
        "Authorization": `Bearer ${currentDeviceToken}`,
      },
    });

    if (res.status === 401) {
      console.warn("DeviceToken ongeldig, opnieuw pairen.");
      localStorage.removeItem("signageLiteDevice");
      startPairingFlow();
      return;
    }

    if (!res.ok) {
      console.warn("Playlist fout:", res.status);
      debugPlaylistEl.textContent = `Playlist laden mislukt (${res.status})`;
      return;
    }

    const data = await res.json();

    const canvasText =
      data.designWidth && data.designHeight
        ? `${data.designWidth}×${data.designHeight}`
        : "onbekend";

    const screenText = `${window.innerWidth}×${window.innerHeight}`;

    // Fit mode uit backend (valt terug op CONTAIN als er niks is)
    currentFitMode =
      typeof data.fitMode === "string" && data.fitMode.length > 0
        ? data.fitMode
        : "CONTAIN";

    debugPlaylistEl.textContent =
      `Playlist v${data.version} — items: ${data.items.length}`;
    debugCanvasEl.textContent =
      `Canvas: ${canvasText} — screen: ${screenText} — fit: ${currentFitMode}`;

    if (currentPlaylistVersion !== data.version) {
      currentPlaylistVersion = data.version;
      currentItems = data.items || [];
      restartSlideshow();
    }
  } catch (err) {
    console.error("Fout bij ophalen playlist:", err);
    debugPlaylistEl.textContent = "Playlist laden mislukt (fout)";
  }
}


function restartSlideshow() {
  clearSlideshow();

  if (!currentItems || currentItems.length === 0) {
    const msg = document.createElement("div");
    msg.textContent = "Geen content beschikbaar voor deze player.";
    msg.style.fontSize = "24px";
    msg.style.color = "#888";
    mediaContainer.appendChild(msg);
    debugSlideEl.textContent = "Slide: geen items in playlist";
    return;
  }

  runSlideLoop(0);
}

function applyFitMode(element) {
  // Zorg dat het element het hele vlak gebruikt
  element.style.width = "100%";
  element.style.height = "100%";

  let fit = "contain";
  let pos = "center center";

  switch (currentFitMode) {
    case "COVER":
      fit = "cover";
      break;
    case "STRETCH":
      fit = "fill";
      break;
    case "ORIGINAL":
      fit = "none";
      break;
    case "CONTAIN":
    default:
      fit = "contain";
      break;
  }

  element.style.objectFit = fit;
  element.style.objectPosition = pos;
}

function runSlideLoop(index) {
  clearSlideshow();

  if (!currentItems || currentItems.length === 0) {
    debugSlideEl.textContent = "Slide: geen items in playlist";
    return;
  }

  const itemIndex = index % currentItems.length;
  const item = currentItems[itemIndex];

  const durationMs =
    item && item.durationSec && item.durationSec > 0
      ? item.durationSec * 1000
      : 10000;

  if (!item) {
    debugSlideEl.textContent = "Slide: onbekend item";
    slideTimeout = setTimeout(() => runSlideLoop(itemIndex + 1), durationMs);
    return;
  }

  debugSlideEl.textContent =
    `Slide: ${itemIndex + 1}/${currentItems.length} — ` +
    `${item.type} — ${(item.durationSec || 10)}s — fit: ${currentFitMode}`;

  if (item.type === "IMAGE") {
    const img = document.createElement("img");
    img.src = item.url;
    applyFitMode(img);
    mediaContainer.appendChild(img);

    slideTimeout = setTimeout(() => {
      runSlideLoop(itemIndex + 1);
    }, durationMs);
  } else if (item.type === "VIDEO") {
    const video = document.createElement("video");
    video.src = item.url;
    video.autoplay = true;
    video.muted = true;
    video.playsInline = true;
    applyFitMode(video);
    mediaContainer.appendChild(video);

    let timeoutHandle = setTimeout(() => {
      runSlideLoop(itemIndex + 1);
    }, durationMs);

    slideTimeout = timeoutHandle;

    const next = () => {
      if (timeoutHandle) {
        clearTimeout(timeoutHandle);
        timeoutHandle = null;
      }
      runSlideLoop(itemIndex + 1);
    };

    video.addEventListener("ended", next);
    video.addEventListener("error", () => {
      console.warn("Videofout, ga naar volgende item");
      next();
    });
  } else {
    console.warn("Onbekend itemtype:", item.type);
    slideTimeout = setTimeout(() => {
      runSlideLoop(itemIndex + 1);
    }, durationMs);
  }
}

function startPlaybackFlow() {
  clearIntervals();
  clearSlideshow();
  showPlayback();

  // Bij start direct screen info doorgeven
  sendScreenInfo();

  fetchPlaylist();
  playlistInterval = setInterval(fetchPlaylist, POLL_PLAYLIST_INTERVAL_MS);
}

function init() {
  const auth = loadAuth();
  if (auth && auth.deviceId && auth.deviceToken) {
    currentDeviceId = auth.deviceId;
    currentDeviceToken = auth.deviceToken;
    currentPlayerId = auth.playerId || null;
    showPlayback();

    // Direct screen info doorgeven bij herstart met bestaand token
    sendScreenInfo();

    fetchPlaylist();
    playlistInterval = setInterval(fetchPlaylist, POLL_PLAYLIST_INTERVAL_MS);
  } else {
    startPairingFlow();
  }
}

init();
</script>

</body>
</html>
