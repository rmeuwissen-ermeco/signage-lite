<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Signage Lite Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        color: #fff;
        overflow: hidden;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      #root {
        position: relative;
        width: 100%;
        height: 100%;
        background: #000;
      }

      /* ---------- Loading overlay ---------- */
      #loadingOverlay {
        position: fixed;
        inset: 0;
        background: #000;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 9999;
      }

      #loadingOverlay.hidden {
        display: none;
      }

      .loading-inner {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .spinner {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        animation: spin 0.9s linear infinite;
      }

      .loading-text {
        font-size: 16px;
        opacity: 0.9;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* ---------- Pairing scherm ---------- */
      #pairingScreen {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #000;
        color: #fff;
        gap: 16px;
      }

      #pairingCode {
        font-size: 64px;
        letter-spacing: 0.2em;
        font-weight: 700;
      }

      #pairingInfo {
        font-size: 18px;
        opacity: 0.8;
      }

      /* ---------- Playback canvas ---------- */
      #playbackScreen {
        position: absolute;
        inset: 0;
        background: #000;
        display: none;
      }

      #mediaContainer {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
      }

      #imageSlide,
      #videoSlide {
        max-width: 100%;
        max-height: 100%;
      }

      #videoSlide {
        background: #000;
      }

      /* ---------- Debug overlay ---------- */
      #debugOverlay {
        position: fixed;
        left: 8px;
        top: 8px;
        z-index: 9998;
        padding: 8px 10px;
        background: rgba(0, 0, 0, 0.7);
        color: #0f0;
        font-family: "Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco,
          Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        max-width: 480px;
        border-radius: 4px;
        white-space: pre-wrap;
      }

      #debugOverlay.hidden {
        display: none;
      }

      #debugOverlay strong {
        color: #fff;
      }

      #debugOverlay .tag {
        display: inline-block;
        padding: 1px 4px;
        border-radius: 3px;
        background: #222;
        margin-right: 4px;
      }

      #debugOverlay .env-dev {
        color: #0ff;
      }

      #debugOverlay .env-prod {
        color: #ff0;
      }
    </style>
  </head>
  <body>
    <div id="root">
      <!-- Loading overlay tijdens preload -->
      <div id="loadingOverlay">
        <div class="loading-inner">
          <div class="spinner"></div>
          <div class="loading-text">Presentatie wordt voorbereid…</div>
        </div>
      </div>

      <!-- Pairing scherm -->
      <div id="pairingScreen">
        <div id="pairingTitle">Player koppelen…</div>
        <div id="pairingCode">······</div>
        <div id="pairingInfo">
          Voer deze code in bij de player-instellingen in het admin panel.
        </div>
        <div id="pairingStatus">Wachten op koppeling…</div>
      </div>

      <!-- Playback scherm -->
      <div id="playbackScreen">
        <div id="mediaContainer">
          <img id="imageSlide" style="display: none" />
          <video
            id="videoSlide"
            style="display: none"
            playsinline
            muted
            loop
          ></video>
        </div>
      </div>

      <!-- Debug overlay -->
      <div id="debugOverlay">
        <div><span class="tag">Signage Lite Player</span></div>
        <div id="debugText"></div>
      </div>
    </div>

    <script>
      // ---------- Globale state ----------
      const pairingScreen = document.getElementById("pairingScreen");
      const playbackScreen = document.getElementById("playbackScreen");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const pairingCodeEl = document.getElementById("pairingCode");
      const pairingStatusEl = document.getElementById("pairingStatus");

      const imageEl = document.getElementById("imageSlide");
      const videoEl = document.getElementById("videoSlide");
      const debugOverlay = document.getElementById("debugOverlay");
      const debugTextEl = document.getElementById("debugText");

      let deviceId = null;
      let deviceToken = null;
      let playerId = null;

      let currentPlaylist = null;
      let currentIndex = 0;
      let playbackTimer = null;
      let playlistPollTimer = null;
      let lastPlaylistVersion = 0;

      const imageCache = new Map();
      const videoCache = new Map();

      const ENV =
        window.location.hostname === "localhost" ? "development" : "production";

      // ---------- Helpers UI ----------
      function showLoadingOverlay() {
        loadingOverlay.classList.remove("hidden");
      }

      function hideLoadingOverlay() {
        loadingOverlay.classList.add("hidden");
      }

      function showPairingScreen() {
        pairingScreen.style.display = "flex";
        playbackScreen.style.display = "none";
        showLoadingOverlay(); // tot er een pairing code is
      }

      function showPlaybackScreen() {
        pairingScreen.style.display = "none";
        playbackScreen.style.display = "block";
      }

      function clearPlaybackTimer() {
        if (playbackTimer) {
          clearTimeout(playbackTimer);
          playbackTimer = null;
        }
      }

      // ---------- Debug ----------
      function updateDebugOverlay(extra = {}) {
        const screenW = window.innerWidth;
        const screenH = window.innerHeight;

        const lines = [];

        lines.push(
          `<strong>Env:</strong> ${
            ENV === "development"
              ? '<span class="env-dev">development</span>'
              : '<span class="env-prod">production</span>'
          }`
        );
        lines.push(`DeviceId: ${deviceId ?? "?"}`);
        lines.push(`PlayerId: ${playerId ?? "?"}`);
        lines.push(`deviceToken: ${deviceToken ? "✔︎" : "—"}`);

        lines.push(
          `Screen: ${screenW}×${screenH}  | Playlist v${lastPlaylistVersion ?? 0}`
        );

        if (currentPlaylist && currentPlaylist.items) {
          const itemCount = currentPlaylist.items.length;
          lines.push(`Items: ${itemCount}`);
          if (itemCount > 0) {
            const idx = currentIndex % itemCount;
            const item = currentPlaylist.items[idx];
            lines.push(
              `Active: #${idx + 1}/${itemCount}  type=${item.type}  dur=${item
                .durationSec ?? 10}s`
            );
          }
          lines.push(
            `FitMode: ${currentPlaylist.fitMode ?? "CONTAIN"} | Design: ${
              currentPlaylist.designWidth ?? "-"
            }×${currentPlaylist.designHeight ?? "-"}`
          );
        } else {
          lines.push("Nog geen actieve playlist");
        }

        if (extra.message) {
          lines.push("");
          lines.push(`Note: ${extra.message}`);
        }

        debugTextEl.innerHTML = lines.join("\n");
      }

      // Toggle debug overlay met 'd'
      window.addEventListener("keydown", (ev) => {
        if (ev.key === "d" || ev.key === "D") {
          debugOverlay.classList.toggle("hidden");
        }
      });

      // ---------- Preload helpers ----------
      function preloadImage(url) {
        if (!url) return Promise.resolve();

        if (imageCache.has(url)) {
          return imageCache.get(url);
        }

        const p = new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve(url);
          img.onerror = (err) => {
            console.error("Fout bij preloaden afbeelding:", url, err);
            resolve(url);
          };
          img.src = url;
        });

        imageCache.set(url, p);
        return p;
      }

      function preloadVideo(url) {
        if (!url) return Promise.resolve();

        if (videoCache.has(url)) {
          return videoCache.get(url);
        }

        const p = new Promise((resolve) => {
          const v = document.createElement("video");
          v.preload = "auto";
          v.src = url;
          v.onloadedmetadata = () => resolve(url);
          v.onerror = (err) => {
            console.error("Fout bij preloaden video:", url, err);
            resolve(url);
          };
        });

        videoCache.set(url, p);
        return p;
      }

      function preloadPlaylistMedia(playlist) {
        if (!playlist || !Array.isArray(playlist.items)) {
          return Promise.resolve();
        }

        const tasks = playlist.items.map((item) => {
          if (item.type === "IMAGE") {
            return preloadImage(item.url);
          }
          if (item.type === "VIDEO") {
            return preloadVideo(item.url);
          }
          return Promise.resolve();
        });

        return Promise.allSettled(tasks);
      }

      // ---------- Fit mode op media toepassen ----------
      function applyFitMode(fitMode) {
        const mode = (fitMode || "CONTAIN").toUpperCase();

        let objectFit = "contain";
        if (mode === "COVER") objectFit = "cover";
        else if (mode === "STRETCH") objectFit = "fill";
        else if (mode === "ORIGINAL") objectFit = "none";

        imageEl.style.objectFit = objectFit;
        videoEl.style.objectFit = objectFit;
      }

      // ---------- Playback ----------
      async function showSlide(index) {
        if (
          !currentPlaylist ||
          !Array.isArray(currentPlaylist.items) ||
          currentPlaylist.items.length === 0
        ) {
          console.warn("Geen items in playlist");
          updateDebugOverlay({ message: "Geen items in playlist" });
          return;
        }

        currentIndex = index % currentPlaylist.items.length;
        const item = currentPlaylist.items[currentIndex];
        const nextIndex =
          (currentIndex + 1) % currentPlaylist.items.length;

        applyFitMode(currentPlaylist.fitMode);

        if (item.type === "IMAGE") {
          try {
            await preloadImage(item.url);
          } catch (e) {
            console.error("Preload error (image):", e);
          }

          videoEl.pause();
          videoEl.style.display = "none";

          imageEl.style.display = "block";
          imageEl.src = item.url;
        } else if (item.type === "VIDEO") {
          imageEl.style.display = "none";

          videoEl.style.display = "block";
          videoEl.preload = "auto";
          videoEl.src = item.url;
          videoEl.currentTime = 0;
          videoEl
            .play()
            .catch((err) =>
              console.error("Video autoplay mislukte:", err)
            );
        } else {
          console.warn("Onbekend item type:", item.type);
        }

        const durationMs = (item.durationSec ?? 10) * 1000;

        // Preload volgende slide
        const nextItem = currentPlaylist.items[nextIndex];
        if (nextItem && nextItem.type === "IMAGE") {
          preloadImage(nextItem.url).catch(() => {});
        } else if (nextItem && nextItem.type === "VIDEO") {
          preloadVideo(nextItem.url).catch(() => {});
        }

        updateDebugOverlay();

        clearPlaybackTimer();
        playbackTimer = setTimeout(() => {
          showSlide(nextIndex);
        }, durationMs);
      }

      function startPlaybackWithPlaylist(playlist) {
        currentPlaylist = playlist;
        currentIndex = 0;
        showPlaybackScreen();
        hideLoadingOverlay();
        updateDebugOverlay();
        showSlide(0);
      }

      // ---------- Playlist polling ----------
      async function fetchAndMaybeUpdatePlaylist() {
        if (!deviceToken) {
          console.warn("Geen deviceToken beschikbaar, kan playlist niet ophalen.");
          return;
        }

        try {
          const res = await fetch("/api/device/playlist", {
            headers: {
              Authorization: "Bearer " + deviceToken,
            },
          });

          if (!res.ok) {
            console.error(
              "Fout bij ophalen playlist:",
              res.status,
              await res.text()
            );
            return;
          }

          const data = await res.json();

          if (!data || !Array.isArray(data.items)) {
            console.warn("Playlist zonder items ontvangen");
            return;
          }

          if (data.version === lastPlaylistVersion) {
            // niets veranderd, gewoon doorspelen
            return;
          }

          console.log("Nieuwe playlist-versie:", data.version);
          lastPlaylistVersion = data.version;

          clearPlaybackTimer();
          showLoadingOverlay();
          updateDebugOverlay({ message: "Nieuwe playlist wordt geladen…" });

          await preloadPlaylistMedia(data);

          startPlaybackWithPlaylist(data);
        } catch (err) {
          // BELANGRIJK: niet resetten bij netwerkfout; huidige playlist blijft lopen
          console.error("Netwerkfout bij ophalen playlist:", err);
          updateDebugOverlay({
            message: "Netwerkfout bij ophalen playlist; huidige loopt door",
          });
        }
      }

      function startPlaylistPolling() {
        // direct eerste keer proberen
        fetchAndMaybeUpdatePlaylist();
        // daarna elke 15s
        playlistPollTimer = setInterval(fetchAndMaybeUpdatePlaylist, 15000);
      }

      // ---------- Screen size doorgeven ----------
      let screenUpdateTimeout = null;

      function sendScreenSize() {
        if (!deviceToken) return;

        const payload = {
          screenWidth: window.innerWidth,
          screenHeight: window.innerHeight,
        };

        fetch("/api/device/screen", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + deviceToken,
          },
          body: JSON.stringify(payload),
        }).catch((err) =>
          console.error("Fout bij doorgeven screen size:", err)
        );
      }

      function scheduleScreenSizeUpdate() {
        if (screenUpdateTimeout) {
          clearTimeout(screenUpdateTimeout);
        }
        screenUpdateTimeout = setTimeout(sendScreenSize, 500);
      }

      window.addEventListener("resize", scheduleScreenSizeUpdate);

      // ---------- Pairing flow ----------
      async function registerDevice() {
        showPairingScreen();
        showLoadingOverlay();

        try {
          const res = await fetch("/api/devices/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              platform: "web-player",
              deviceName: navigator.userAgent.slice(0, 80),
            }),
          });

          if (!res.ok) {
            const text = await res.text();
            console.error("Fout bij register:", res.status, text);
            pairingStatusEl.textContent =
              "Fout bij registreren device. Probeer de pagina te verversen.";
            hideLoadingOverlay();
            return;
          }

          const data = await res.json();
          deviceId = data.deviceId;
          pairingCodeEl.textContent = data.pairingCode ?? "??????";
          pairingStatusEl.textContent = "Wachten op koppeling…";

          localStorage.setItem("sl_deviceId", String(deviceId));

          hideLoadingOverlay();
          updateDebugOverlay();

          pollPairingStatus();
        } catch (err) {
          console.error("Netwerkfout bij register:", err);
          pairingStatusEl.textContent =
            "Netwerkfout bij registreren device. Controleer verbinding.";
          hideLoadingOverlay();
        }
      }

      async function pollPairingStatus() {
        if (!deviceId) return;

        async function checkOnce() {
          try {
            const res = await fetch(`/api/devices/${deviceId}/status`);
            if (!res.ok) {
              console.error(
                "Fout bij status check:",
                res.status,
                await res.text()
              );
              return;
            }

            const data = await res.json();

            if (data.status === "PAIRED") {
              pairingStatusEl.textContent = "Gekoppeld! Player wordt geladen…";

              deviceToken = data.deviceToken;
              playerId = data.playerId ?? null;

              localStorage.setItem("sl_deviceToken", deviceToken);
              localStorage.setItem("sl_playerId", String(playerId ?? ""));

              showLoadingOverlay();
              updateDebugOverlay({
                message: "Gekoppeld; playlist wordt opgehaald…",
              });

              sendScreenSize();
              startPlaylistPolling();
            } else if (data.status === "PENDING") {
              pairingStatusEl.textContent = "Wachten op koppeling…";
            } else if (data.status === "NOT_FOUND") {
              pairingStatusEl.textContent =
                "Device niet gevonden. Pagina verversen om opnieuw te beginnen.";
            }
          } catch (err) {
            console.error("Netwerkfout bij status check:", err);
          }
        }

        // meteen checken + interval
        await checkOnce();
        setInterval(checkOnce, 3000);
      }

      // ---------- Init ----------
      function initFromLocalStorage() {
        const storedDeviceId = localStorage.getItem("sl_deviceId");
        const storedToken = localStorage.getItem("sl_deviceToken");
        const storedPlayerId = localStorage.getItem("sl_playerId");

        if (storedDeviceId && storedToken) {
          deviceId = Number(storedDeviceId);
          deviceToken = storedToken;
          playerId = storedPlayerId ? Number(storedPlayerId) : null;

          console.log("Herstel bestaande device uit localStorage:", {
            deviceId,
            playerId,
          });

          showPairingScreen();
          pairingStatusEl.textContent =
            "Gekoppelde player herstellen… Playlist wordt geladen.";
          pairingCodeEl.textContent = "— — — — — —";

          showLoadingOverlay();
          sendScreenSize();
          startPlaylistPolling();
          updateDebugOverlay({
            message: "Herstel bestaand device uit localStorage",
          });
          return true;
        }

        return false;
      }

      async function init() {
        updateDebugOverlay();

        const restored = initFromLocalStorage();
        if (!restored) {
          await registerDevice();
        }
      }

      init();
    </script>
  </body>
</html>
